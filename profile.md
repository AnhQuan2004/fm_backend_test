# Profile API

APIs that expose user profiles for the updated `users` table. The schema now tracks both wallet addresses and email addresses.

## Schema Snapshot

| Column         | Type      | Notes                                        |
| -------------- | --------- | -------------------------------------------- |
| `id`           | `uuid`    | Primary key generated by Supabase            |
| `email`          | `text`  | Unique email identifier (required)           |
| `wallet_address` | `text`  | Unique wallet identifier (required)          |
| `username`     | `text`    | Optional unique username                     |
| `role`         | `enum`    | `admin`, `organizer`, or `user` (default)    |
| `xp_points`    | `integer` | Cumulative XP (defaults to `0`)              |
| `created_at`   | `timestamptz` | Auto timestamp from Supabase            |

Only the highlighted fields above are exposed through the current endpoints.

## Endpoints

| Method | Path                         | Purpose                        |
| ------ | ---------------------------- | ------------------------------ |
| `GET`  | `/api/auth/profile`          | Fetch profile by wallet/email or list all |
| `POST` | `/api/auth/profile`          | Create or update profile       |
| `PATCH` | `/api/auth/profile/role`    | Update a user's role (requires auth) |

### GET `/api/auth/profile`

Query params:

| Name            | Required | Description                                                                 |
| --------------- | -------- | --------------------------------------------------------------------------- |
| `walletAddress` | No       | Wallet to look up                                                           |
| `email`         | No       | Email to look up (falls back to session email when omitted)                 |
| `all`           | No       | When set to `true`, return an array of every profile (ignores other params) |

Notes:
- At least one of `walletAddress` or `email` is required when `all` is not `true`.  
- If neither is provided, the handler tries to infer the email from the current session; if that fails it returns `400`.

Example:

```bash
curl -X GET "http://localhost:3000/api/auth/profile?walletAddress=0xabc123" \
  -H "Accept: application/json"
```

Fetch by email:

```bash
curl -X GET "http://localhost:3000/api/auth/profile?email=user@example.com" \
  -H "Accept: application/json"
```

Fetch all profiles:

```bash
curl -X GET "http://localhost:3000/api/auth/profile?all=true" \
  -H "Accept: application/json"
```

Success response (`200`):

```json
{
  "ok": true,
  "profile": {
    "id": "3623b9d4-0bf7-49b3-9504-0f339fe8a94f",
    "email": "user@example.com",
    "walletAddress": "0xabc123",
    "username": "builder01",
    "xpPoints": 1200,
    "role": "user",
    "createdAt": "2024-05-11T06:31:42.891Z"
  }
}
```

`all=true` returns:

```json
{
  "ok": true,
  "profiles": [
    {
      "id": "...",
      "email": "user@example.com",
      "walletAddress": "0xabc123",
      "username": "builder01",
      "xpPoints": 1200,
      "role": "user",
      "createdAt": "..."
    }
  ]
}
```

Errors:

| Code | Message                       | Notes                                    |
| ---- | ----------------------------- | ---------------------------------------- |
| 400  | `Missing walletAddress hoặc email` | Neither identifier nor session email was provided. |
| 404  | `User not found`              | No row matched the provided identifier.  |
| 500  | `Failed to fetch profile`     | Supabase error (see server logs).        |

### POST `/api/auth/profile`

Body schema:

| Field          | Type    | Required | Validation                                                  |
| -------------- | ------- | -------- | ----------------------------------------------------------- |
| `email`        | string  | Yes      | Valid email format; trimmed & lower‑cased                   |
| `walletAddress`| string  | Yes      | Trimmed, must be non-empty                                  |
| `username`     | string  | No       | 3–50 chars, alphanumeric plus `. _ -`, unique per table     |
| `xpPoints`     | number  | No       | Integer, ≥ 0                                                |

Example:

```bash
curl -X POST "http://localhost:3000/api/auth/profile" \
  -H "Content-Type: application/json" \
  -d '{
        "email": "user@example.com",
        "walletAddress": "0xabc123",
        "username": "builder01",
        "xpPoints": 1200
      }'
```

The endpoint performs an UPSERT on `email`, ensuring idempotent updates per address. Additional guards prevent reusing usernames or wallet addresses that belong to another user.

Success response mirrors the GET payload. Possible errors:

| Code | Message / Structure                         | Cause                                               |
| ---- | ------------------------------------------- | --------------------------------------------------- |
| 400  | `{ ok: false, error: { username: ["..."] } }` | Username already in use                             |
| 400  | `{ ok: false, error: { walletAddress: ["..."] } }` | Wallet already linked to another user or validation failure |
| 500  | `Failed to save profile`                    | Supabase insert/update failure                      |

### PATCH `/api/auth/profile/role`

Requires a valid session unless the backend runs in bypass mode. Body schema:

```json
{
  "walletAddress": "0xabc123",
  "role": "organizer"
}
```

Role options are `user`, `organizer`, and `admin`.

Example:

```bash
curl -X PATCH "http://localhost:3000/api/auth/profile/role" \
  -H "Content-Type: application/json" \
  -H "Cookie: session=<token>" \
  -d '{ "walletAddress": "0xabc123", "role": "admin" }'
```

Response:

```json
{
  "ok": true,
  "user": {
    "walletAddress": "0xabc123",
    "role": "admin"
  }
}
```

Errors:

| Code | Message                    | Notes                                 |
| ---- | -------------------------- | ------------------------------------- |
| 401  | `Unauthorized`             | Missing/invalid session & no bypass   |
| 400  | Validation errors          | Wallet or role invalid                |
| 404  | `User not found`           | Wallet does not exist                 |
| 500  | `Failed to update role`    | Supabase update failure               |

## Local Testing Tips

1. Ensure `.env` supplies `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` (or anon key if RLS disabled).
2. When auth is required, use the OTP flow to obtain a `session` cookie or set the `ALLOW_UNAUTHENTICATED=true` bypass variables for development.
3. Use the curl snippets above to verify GET/POST/PATCH behaviors as you migrate clients to the wallet-based schema.
